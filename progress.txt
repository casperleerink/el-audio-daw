## 2026-01-29 - Optimistic Update Utilities

### Completed
Created `apps/web/src/lib/optimistic.ts` with the following utilities:

1. **`tempId<TableName>()`** - Generates temporary client IDs prefixed with `temp_` followed by a UUID. Used for optimistic creates before server confirms with real ID.

2. **`MaybePending<T>`** - Type alias for entities that may be in a pending state. Adds optional `_pending` flag.

3. **`isPending(entity)`** - Checks if an entity has a temp ID (starts with `temp_` prefix). Useful for disabling certain actions on pending entities.

4. **`showRollbackToast(action)`** - Shows a toast notification for failed mutations with the message "Failed to [action]. Changes reverted."

### Notes for next person
- The utilities follow the pattern defined in FR-8 of the PRD
- The `tempId` function is constrained to `TableNames` from Convex's generated types for type safety
- These utilities are foundational - the next task should be implementing optimistic updates for track mutations
- The existing `useOptimisticTrackUpdates` hook in `apps/web/src/hooks/` handles track control updates (mute/solo/gain) but doesn't use Convex's `withOptimisticUpdate` API - it uses local React state instead
- Consider whether to refactor that hook to use these new utilities or keep both patterns depending on use case

## 2026-01-29 - Track Mutations Optimistic Updates

### Completed
Implemented optimistic updates for all track mutations using Convex's `withOptimisticUpdate` API.

**New file created:** `apps/web/src/lib/trackOptimisticUpdates.ts`
- `createTrackOptimisticUpdate` - Instantly adds a new track with a temp ID
- `updateTrackOptimisticUpdate` - Instantly applies name/mute/solo/gain changes
- `deleteTrackOptimisticUpdate` - Instantly removes track from list
- `reorderTracksOptimisticUpdate` - Instantly reorders tracks in the cache

**Files modified:**
1. `packages/backend/convex/tracks.ts`
   - Added optional `projectId` arg to `updateTrack` and `deleteTrack` mutations (used for optimistic update cache invalidation)

2. `apps/web/src/routes/project.$id.tsx`
   - Wired up all track mutations with `withOptimisticUpdate`
   - Removed loading states (`isAddingTrack`, `deletingTrackId`) since optimistic updates make actions feel instant
   - Replaced manual error toasts with `showRollbackToast` for consistent error handling

3. `apps/web/src/components/VirtualizedTrackList.tsx`
   - Removed `isAddingTrack` and `deletingTrackId` props
   - Removed `isDeleting` prop from TrackHeader
   - Simplified UI since loading states are no longer needed

### Architecture decisions
- Track mutations now use Convex's native `withOptimisticUpdate` for instant feedback
- The existing `useOptimisticTrackUpdates` hook remains for mute/solo/gain controls since those use a commit-based pattern (local state during interaction, server update on commit)
- Both patterns coexist: Convex optimistic updates for CRUD operations, local React state for continuous interactions

### Notes for next person
- Next priority task: Implement optimistic updates for clip mutations
- The `updateTrack` and `deleteTrack` mutations now accept an optional `projectId` arg - always pass it to enable optimistic updates
- If you need to check if a track is pending (temp ID), use the `isPending()` utility from `@/lib/optimistic`

## 2026-01-29 - Clip Mutations Optimistic Updates

### Completed
Implemented optimistic updates for all clip mutations using Convex's `withOptimisticUpdate` API.

**New file created:** `apps/web/src/lib/clipOptimisticUpdates.ts`
- `createClipOptimisticUpdate` - Instantly adds a new clip with a temp ID to the cache
- `updateClipPositionOptimisticUpdate` - Instantly updates clip's startTime in the cache (for drag operations)
- `deleteClipOptimisticUpdate` - Instantly removes clip from the cache

**Files modified:**
1. `packages/backend/convex/clips.ts`
   - Added optional `projectId` arg to `updateClipPosition` and `deleteClip` mutations (required for optimistic update cache invalidation)

2. `apps/web/src/hooks/useClipDrag.ts`
   - Added `projectId` parameter to the hook
   - Updated mutation call to include `projectId` for optimistic updates
   - Updated error toast to use rollback messaging

3. `apps/web/src/routes/project.$id.tsx`
   - Wired up `updateClipPosition` mutation with `withOptimisticUpdate`
   - Prepared `deleteClip` mutation with optimistic updates (prefixed with `_` since no delete UI exists yet)
   - Passed `projectId` to `useClipDrag` hook

### Architecture decisions
- Clip mutations follow the same pattern as track mutations
- `updateClipPosition` is used for drag-to-move operations - optimistic update provides instant visual feedback when dropping a clip
- `deleteClip` is prepared but not wired to UI yet (no clip delete UI exists)
- `createClip` optimistic update exists but isn't used during upload flow yet - the upload flow currently waits for server confirmation

### Notes for next person
- Next priority tasks: "Implement commit-based updates for continuous interactions" or "Add pending state UI for clips"
- The `updateClipPosition` and `deleteClip` mutations now accept optional `projectId` - always pass it for optimistic updates
- Use `isPending()` from `@/lib/optimistic` to check if a clip has a temp ID (pending confirmation)
- The clip deletion UI needs to be implemented before `deleteClip` can be fully utilized

## 2026-01-29 - Commit-Based Updates for Continuous Interactions

### Completed
Implemented commit-based pattern for gain sliders following FR-6 of the PRD. Gain now updates the audio engine in real-time during slider drag, but only commits to the server on slider release.

**Files modified:**

1. `apps/web/src/components/ui/slider.tsx`
   - Added `onValueCommit` prop that fires on pointer up
   - Tracks current value in a ref to pass to commit callback

2. `apps/web/src/components/VirtualizedTrackList.tsx`
   - Added `onGainCommit` prop to `TrackHeaderProps` and `VirtualizedTrackListProps`
   - `TrackHeader` now uses local `localGain` state for real-time slider feedback
   - `handleGainChange` updates local state + calls `onGainChange` for audio engine
   - `handleGainCommit` commits to server only when value differs from original
   - Added `isDraggingGainRef` to prevent server state from overwriting local state during drag

3. `apps/web/src/hooks/useOptimisticTrackUpdates.ts`
   - Separated gain handlers: `handleUpdateTrackGain` (local only) vs `handleCommitTrackGain` (server)
   - `handleUpdateTrackGain` now only applies local optimistic state (no server call)
   - `handleCommitTrackGain` sends to server and clears optimistic state on completion
   - Mute/solo continue to use immediate update pattern (single click actions)

4. `apps/web/src/routes/project.$id.tsx`
   - Wired up both `onGainChange` and `onGainCommit` to `VirtualizedTrackList`

### Architecture decisions
- Gain slider now follows the commit-based pattern from FR-6
- Track reorder and clip drag were already using commit-based patterns (no changes needed)
- Mute/solo remain immediate (they're discrete toggles, not continuous interactions)
- The Slider component's `onValueCommit` uses `onPointerUp` to detect release

### Notes for next person
- All continuous interactions (gain, track reorder, clip drag) now use commit-based pattern
- Next priority tasks: "Implement upload cancellation" or "Implement optimistic update for project"
- The audio engine receives gain updates in real-time via `onGainChange`, providing instant audio feedback
- Server mutations only fire on commit, reducing unnecessary network requests during slider drag

## 2026-01-29 - Project Optimistic Update

### Completed
Implemented optimistic update for the `updateProject` mutation, enabling instant project name changes.

**New file created:** `apps/web/src/lib/projectOptimisticUpdates.ts`
- `updateProjectOptimisticUpdate` - Instantly applies name change to the `getProject` query cache

**Files modified:**

1. `apps/web/src/routes/project.$id.tsx`
   - Wired up `updateProject` mutation with `withOptimisticUpdate`
   - Removed `isSavingProjectName` loading state since optimistic updates make the action feel instant
   - Replaced `toast.success`/`toast.error` with `showRollbackToast` for consistent error handling
   - Simplified the settings dialog (no loading spinner on save button)
   - Removed unused `toast` import from sonner

### Architecture decisions
- Project mutation follows the same pattern as track/clip mutations
- The dialog now closes immediately on save, with the name change appearing instantly
- On failure, Convex reverts the cache and `showRollbackToast` notifies the user

### Notes for next person
- Remaining tasks: "Implement upload cancellation", "Update audio engine sync", "Add pending state UI for clips"
- The optimistic update pattern is now complete for all main entities: tracks, clips, and project
