# Audio Clips Feature Progress

## 2026-01-28 - Schema Changes Complete

### Completed
- Added `clips` table to Convex schema with all required fields:
  - projectId, trackId, fileId (storage ID), name, startTime, duration, audioStartTime, gain, timestamps
  - Indexes: by_track (trackId), by_project (projectId)
- Added `color` field (optional string) to tracks table for clip rendering
- Added `duration` field (optional number, in samples) to projects table
- Added `sampleRate` field (optional number) to projects table

### Implementation Notes
- All new fields are optional to maintain backward compatibility with existing data
- The `fileId` field uses `v.id("_storage")` which is Convex's built-in storage ID type
- Track colors are stored as hex strings (e.g., "#FF5733")
- Duration and sampleRate on projects will be set when first clip is uploaded

### Next Priority Tasks
1. Create Convex file upload mutation (FR-5 through FR-8)
2. Create clip CRUD mutations (create, update position, delete)
3. Create query to get clips for a project

### Files Modified
- packages/backend/convex/schema.ts

---

## 2026-01-28 - Clip Mutations Complete

### Completed
- Created `packages/backend/convex/clips.ts` with full clip functionality:
  - `generateUploadUrl`: Generates Convex storage upload URL for authenticated users (FR-8)
  - `validateUploadedFile`: Validates file size (100MB max, FR-6) and content type (FR-5, FR-7)
  - `createClip`: Creates clip with overlap handling (FR-9, FR-12), auto-extends project duration (FR-13)
  - `updateClipPosition`: Moves clip with overlap handling (FR-34-38), clamps to 0 (FR-38)
  - `deleteClip`: Deletes clip and associated storage file
  - `getProjectClips`: Query to get all clips for a project
  - `getProjectClipUrls`: Query to get storage URLs for VFS loading (FR-17)
  - `getFileUrl`: Query to get URL for a single stored file

### Implementation Notes
- All mutations follow existing auth pattern with `checkProjectAccess` helper
- Clip overlap handling: truncates or deletes existing clips when new/moved clip overlaps
- Project duration auto-extends to clip end + 10 seconds of samples
- Supported audio formats: WAV, MP3, AIFF, FLAC, OGG
- File validation happens after upload to Convex (delete invalid files immediately)
- Storage ID (`fileId`) is used as VFS key for Elementary Audio integration

### Next Priority Tasks
1. Set up Elementary VFS integration in AudioEngine
2. Add method to load audio buffer into VFS
3. Update audio graph to render clips at correct positions
4. Implement drag-drop zone on timeline track lanes

### Files Modified
- packages/backend/convex/clips.ts (new file)
