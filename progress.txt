# Audio Clips Feature Progress

## 2026-01-28 - Schema Changes Complete

### Completed
- Added `clips` table to Convex schema with all required fields:
  - projectId, trackId, fileId (storage ID), name, startTime, duration, audioStartTime, gain, timestamps
  - Indexes: by_track (trackId), by_project (projectId)
- Added `color` field (optional string) to tracks table for clip rendering
- Added `duration` field (optional number, in samples) to projects table
- Added `sampleRate` field (optional number) to projects table

### Implementation Notes
- All new fields are optional to maintain backward compatibility with existing data
- The `fileId` field uses `v.id("_storage")` which is Convex's built-in storage ID type
- Track colors are stored as hex strings (e.g., "#FF5733")
- Duration and sampleRate on projects will be set when first clip is uploaded

### Next Priority Tasks
1. Create Convex file upload mutation (FR-5 through FR-8)
2. Create clip CRUD mutations (create, update position, delete)
3. Create query to get clips for a project

### Files Modified
- packages/backend/convex/schema.ts

---

## 2026-01-28 - Clip Mutations Complete

### Completed
- Created `packages/backend/convex/clips.ts` with full clip functionality:
  - `generateUploadUrl`: Generates Convex storage upload URL for authenticated users (FR-8)
  - `validateUploadedFile`: Validates file size (100MB max, FR-6) and content type (FR-5, FR-7)
  - `createClip`: Creates clip with overlap handling (FR-9, FR-12), auto-extends project duration (FR-13)
  - `updateClipPosition`: Moves clip with overlap handling (FR-34-38), clamps to 0 (FR-38)
  - `deleteClip`: Deletes clip and associated storage file
  - `getProjectClips`: Query to get all clips for a project
  - `getProjectClipUrls`: Query to get storage URLs for VFS loading (FR-17)
  - `getFileUrl`: Query to get URL for a single stored file

### Implementation Notes
- All mutations follow existing auth pattern with `checkProjectAccess` helper
- Clip overlap handling: truncates or deletes existing clips when new/moved clip overlaps
- Project duration auto-extends to clip end + 10 seconds of samples
- Supported audio formats: WAV, MP3, AIFF, FLAC, OGG
- File validation happens after upload to Convex (delete invalid files immediately)
- Storage ID (`fileId`) is used as VFS key for Elementary Audio integration

### Next Priority Tasks
1. Set up Elementary VFS integration in AudioEngine
2. Add method to load audio buffer into VFS
3. Update audio graph to render clips at correct positions
4. Implement drag-drop zone on timeline track lanes

### Files Modified
- packages/backend/convex/clips.ts (new file)

---

## 2026-01-28 - VFS Integration Complete

### Completed
- Added Virtual File System (VFS) integration to AudioEngine (FR-15, FR-16, FR-18):
  - `loadAudioIntoVFS(key, url)`: Fetches audio from URL, decodes with Web Audio API, and loads into Elementary VFS
  - `isAudioLoaded(key)`: Checks if audio is already loaded in VFS
  - `getVFSEntry(key)`: Gets metadata (channels, duration, sampleRate) for loaded audio
  - `getVFSEntries()`: Returns all loaded VFS entries
  - `getSampleRate()`: Returns AudioContext sample rate
  - `pruneVFS(activeKeys)`: Removes unused audio from VFS
- Added `VFSEntry` interface to track loaded audio metadata
- Exported `VFSEntry` type from audio package

### Implementation Notes
- VFS key is the Convex storage ID (same as `fileId` in clips table)
- Mono audio uses key directly, stereo uses `key:0` and `key:1` format (Elementary convention)
- Metadata (channels, duration, sampleRate) is stored locally for later use when rendering clips
- Audio is only loaded once per key (caches in vfsEntries map)
- dispose() now clears vfsEntries to prevent memory leaks

### Next Priority Tasks
1. Update audio graph to render clips at correct positions (use el.sampleseq for timeline playback)
2. Implement drag-drop zone on timeline track lanes
3. Render clip rectangles on timeline canvas

### Files Modified
- packages/audio/src/engine.ts (added VFS methods and VFSEntry type)
- packages/audio/src/index.ts (exported VFSEntry type)

---

## 2026-01-28 - Audio Graph Clip Rendering Complete

### Completed
- Updated AudioEngine to render clips at correct timeline positions (FR-19 through FR-23):
  - Added `ClipState` interface with all required fields (id, trackId, fileId, startTime, duration, audioStartTime, gain)
  - Added `clips` array to `AudioEngineState`
  - Added `setClips(clips)` method to update clip state and re-render audio graph
  - Updated `renderGraph()` to render clips using `el.sampleseq` (mono) and `el.mc.sampleseq` (stereo)
  - Clips play at their timeline positions (`startTime` in samples converted to seconds)
  - Clips only play during their duration (FR-23)
  - Multiple clips on same track sum together (FR-21)
  - Clip gain applied before track gain (FR-20)
  - Track mute/solo logic applied at track level (FR-22)
- Exported `ClipState` type from audio package

### Implementation Notes
- Uses `el.sampleseq` for mono clips, `el.mc.sampleseq` for stereo clips
- Time signal: `el.div(el.time(), el.sr())` provides time in seconds
- Sequence format: `{time: startSeconds, value: 1}` to trigger, `{time: endSeconds, value: 0}` to stop
- If audio not loaded in VFS yet, clip renders silence (graceful degradation)
- Full stereo support: renders separate left/right channels, summed per track then to master
- Keys used throughout for efficient Elementary Audio graph updates

### Audio Signal Flow (FR-20)
```
Clip 1 (gain) ──┐
Clip 2 (gain) ──┼──> Track Sum ──> Track Gain ──┐
                                                 │
Clip 3 (gain) ──> Track Sum ──> Track Gain ─────┼──> Master Gain ──> Output
                                                 │
(mute/solo applied at track level)              │
```

### Next Priority Tasks
1. Implement drag-drop zone on timeline track lanes (FR-29-33)
2. Calculate drop position in samples from mouse position (FR-31)
3. Decode audio file client-side (FR-10)
4. Render clip rectangles on timeline canvas (FR-24-28)

### Files Modified
- packages/audio/src/engine.ts (added ClipState, setClips, updated renderGraph)
- packages/audio/src/index.ts (exported ClipState type)

---

## 2026-01-28 - Clip Timeline Rendering Complete

### Completed
- Implemented clip rectangle rendering on timeline canvas (FR-24 through FR-28):
  - Added `ClipData` interface for clip data passed to TimelineCanvas
  - Added `clips` and `sampleRate` props to TimelineCanvas component
  - Added `getProjectClips` query in ProjectEditor component
  - Implemented `getTrackColor(index)` function for deterministic track colors using golden angle
  - Clips render as rounded rectangles with track-inherited colors (FR-24)
  - Clip rectangles display filename with truncation for long names (FR-25)
  - Clip width calculated from duration: `duration * pixelsPerSecond / sampleRate` (FR-26)
  - Clip x position calculated from startTime: `startTime * pixelsPerSecond / sampleRate` (FR-27)
  - Normal visual state: semi-transparent fill (0.7 alpha) with solid border (FR-28)

### Implementation Notes
- Track colors generated deterministically using golden angle (137.508°) for even hue distribution
- Colors use HSL format: `hsl(hue, 65%, 55%)` for vibrant but not overwhelming colors
- Clips skip rendering when outside visible time range (horizontal culling)
- Clips skip rendering when their track is outside visible area (vertical culling)
- Text truncation uses canvas measureText for accurate width calculation
- Uses `ctx.roundRect()` for rounded corners on clip rectangles
- Sample rate defaults to 44100 if project.sampleRate is not set

### Technical Details
- Clip position formula: `clipX = (clipStartSeconds - scrollStartTime) * pixelsPerSecond`
- Clip width formula: `clipWidth = clipDurationSeconds * pixelsPerSecond`
- Track Y position: `RULER_HEIGHT + trackIndex * TRACK_HEIGHT - scrollTop`
- Clip has 2px padding inside track lane for visual separation

### Next Priority Tasks
1. Implement drag-drop zone on timeline track lanes (FR-29-33)
2. Calculate drop position in samples from mouse position (FR-31)
3. Decode audio file client-side to get duration/sample rate (FR-10)
4. Upload file to Convex on drop (FR-8)

### Files Modified
- apps/web/src/routes/project.$id.tsx (added clip rendering to TimelineCanvas)

---

## 2026-01-28 - Drag-Drop File Upload Complete

### Completed
- Implemented drag-drop file upload for audio clips on timeline (FR-29 through FR-33):
  - Added drag-drop event handlers (`handleDragEnter`, `handleDragOver`, `handleDragLeave`, `handleDrop`)
  - Visual feedback when dragging file over timeline (FR-30): overlay with "Drop audio file on a track" message
  - Drop target indicator: vertical line showing where clip will be placed
  - Calculate drop position in samples from mouse position (FR-31): `(mouseX + scrollLeft) / pixelsPerSecond * sampleRate`
  - Track detection from Y position: `Math.floor((canvasY - RULER_HEIGHT + scrollTop) / TRACK_HEIGHT)`
- Client-side audio file validation (FR-5, FR-6, FR-7):
  - Validate file size (max 100MB)
  - Validate audio format (WAV, MP3, AIFF, FLAC, OGG)
- Audio file decoding to get duration (FR-10):
  - Uses Web Audio API `decodeAudioData` to decode file
  - Extracts duration in samples and file sample rate
  - Shows warning if sample rate differs from project (FR-11)
- File upload to Convex storage (FR-8):
  - Generate upload URL via `generateUploadUrl` mutation
  - POST file to upload URL
  - Validate uploaded file via `validateUploadedFile` mutation
- Create clip record after upload (FR-9):
  - Uses `createClip` mutation with track ID, file ID, start time, duration
  - Clip name derived from filename (without extension)
- Loading state during upload (FR-32): overlay with spinner and "Uploading audio..." text
- Error state on upload failure (FR-33): toast notification with error message

### Implementation Notes
- Drop zone highlights entire timeline with semi-transparent primary color overlay
- Drop target indicator is a vertical line at the calculated drop position
- Uses same constants for supported audio types and max file size as backend
- Creates AudioContext on demand for decoding, then closes it to free resources
- All mutations are called in sequence: generateUploadUrl → upload → validateUploadedFile → createClip
- Successful upload shows toast with clip name
- Failed uploads show toast with error message (file validation errors, upload failures, etc.)

### Technical Details
- `DropTarget` interface tracks trackId, trackIndex, and dropTimeInSamples
- `calculateDropPosition(clientX, clientY)` computes drop target from mouse coordinates
- `decodeAudioFile(file)` returns `{ durationInSamples, fileSampleRate }`
- Drop indicator position calculated as: `(dropTimeInSamples / sampleRate - scrollLeft / pixelsPerSecond) * pixelsPerSecond`

### Next Priority Tasks
1. Implement clip dragging to move position (FR-34-38)
2. Load all project clips into VFS on page load (FR-17)
3. Auto-extend project duration when clip placed near/past end (FR-13 - already handled in backend)

### Files Modified
- apps/web/src/routes/project.$id.tsx (added drag-drop handlers, visual feedback, file upload flow)

---

## 2026-01-28 - VFS Loading on Page Load Complete

### Completed
- Implemented loading all project clips into VFS when audio engine initializes (FR-17):
  - Added `getProjectClipUrls` query to fetch all clip URLs for VFS loading
  - Added `isEngineReady` state to track when audio engine is initialized
  - Added `useEffect` that loads all project clips into VFS when:
    - Audio engine is initialized (`isEngineReady` becomes true)
    - Clips or clipUrls change (new clip uploaded, clip deleted, etc.)
  - After loading audio into VFS, syncs clip state to AudioEngine for playback
  - Uses idempotent `loadAudioIntoVFS` to avoid reloading already-loaded audio

### Implementation Notes
- The `clipUrls` query returns fileId -> URL mapping for all project clips
- A `urlMap` is built for O(1) lookups when loading clips
- Loading is done in parallel with `Promise.all` for better performance
- After all audio is loaded, `setClips()` is called to update the audio graph
- The `isEngineReady` state ensures the effect re-runs when engine initializes (even if clips were already loaded)
- Failed loads are logged but don't block other clips from loading

### Audio Playback Flow
1. User opens project page
2. `clips` and `clipUrls` queries return project data
3. User presses Play, triggering audio engine initialization
4. `isEngineReady` becomes true, triggering VFS loading effect
5. All clip audio is fetched, decoded, and loaded into VFS
6. Clip state is synced to AudioEngine via `setClips()`
7. AudioEngine renders clips at correct timeline positions with `el.sampleseq`

### Next Priority Tasks
1. Implement clip dragging to move position (FR-34-38)
2. Handle clip overlap during move (FR-37) - already handled in backend
3. Auto-extend project duration when clip placed near/past end (FR-13) - already handled in backend

### Files Modified
- apps/web/src/routes/project.$id.tsx (added VFS loading on engine init, clipUrls query, isEngineReady state)

---

## 2026-01-28 - Clip Dragging to Move Position Complete

### Completed
- Implemented clip dragging to move position (FR-34 through FR-38):
  - Added `ClipDragState` interface to track clip being dragged and its position
  - Added `findClipAtPosition()` helper to detect which clip is under the mouse cursor
  - Added `handleMouseDown` to initiate drag when clicking on a clip (FR-34)
  - Added `handleClipDragMove` to update drag position during mouse move (FR-35)
  - Added `handleClipDragEnd` to commit new position to database on mouse up (FR-36)
  - Visual feedback during drag: reduced opacity (0.5 fill, 0.7 border) and thicker border (FR-35)
  - Cursor changes to `grabbing` while dragging
  - Start time clamped to 0 on frontend before sending to backend (FR-38)
  - Backend `updateClipPosition` mutation already handles overlap (FR-37) and project duration extension (FR-13)

### Implementation Notes
- Clips are now rendered at their `currentStartTime` during drag, giving immediate visual feedback
- Used `justFinishedDragRef` to prevent click event from firing seek after drag ends
- Click on clip no longer triggers timeline seek (users must click empty track area to seek)
- All position calculations use samples for precision, converting to/from seconds only for display

### Visual States During Drag
- Fill opacity: 0.7 → 0.5 (indicates dragging state)
- Border opacity: 1 → 0.7
- Border width: 1px → 2px (makes clip more visible during drag)
- Text opacity: 0.9 → 0.6

### Files Modified
- apps/web/src/routes/project.$id.tsx (added clip drag handlers, ClipDragState, findClipAtPosition, visual feedback during drag)

### PRD Status
All tasks in the Audio Clips PRD are now complete:
- Schema changes ✓
- File upload mutations ✓
- Clip CRUD mutations ✓
- VFS integration ✓
- Audio graph clip rendering ✓
- Timeline canvas clip rendering ✓
- Drag-drop file upload ✓
- VFS loading on page load ✓
- Clip dragging to move position ✓
- Clip overlap handling ✓ (backend)
- Auto-extend project duration ✓ (backend)
