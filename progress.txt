## 2026-01-29 - Optimistic Update Utilities

### Completed
Created `apps/web/src/lib/optimistic.ts` with the following utilities:

1. **`tempId<TableName>()`** - Generates temporary client IDs prefixed with `temp_` followed by a UUID. Used for optimistic creates before server confirms with real ID.

2. **`MaybePending<T>`** - Type alias for entities that may be in a pending state. Adds optional `_pending` flag.

3. **`isPending(entity)`** - Checks if an entity has a temp ID (starts with `temp_` prefix). Useful for disabling certain actions on pending entities.

4. **`showRollbackToast(action)`** - Shows a toast notification for failed mutations with the message "Failed to [action]. Changes reverted."

### Notes for next person
- The utilities follow the pattern defined in FR-8 of the PRD
- The `tempId` function is constrained to `TableNames` from Convex's generated types for type safety
- These utilities are foundational - the next task should be implementing optimistic updates for track mutations
- The existing `useOptimisticTrackUpdates` hook in `apps/web/src/hooks/` handles track control updates (mute/solo/gain) but doesn't use Convex's `withOptimisticUpdate` API - it uses local React state instead
- Consider whether to refactor that hook to use these new utilities or keep both patterns depending on use case

## 2026-01-29 - Track Mutations Optimistic Updates

### Completed
Implemented optimistic updates for all track mutations using Convex's `withOptimisticUpdate` API.

**New file created:** `apps/web/src/lib/trackOptimisticUpdates.ts`
- `createTrackOptimisticUpdate` - Instantly adds a new track with a temp ID
- `updateTrackOptimisticUpdate` - Instantly applies name/mute/solo/gain changes
- `deleteTrackOptimisticUpdate` - Instantly removes track from list
- `reorderTracksOptimisticUpdate` - Instantly reorders tracks in the cache

**Files modified:**
1. `packages/backend/convex/tracks.ts`
   - Added optional `projectId` arg to `updateTrack` and `deleteTrack` mutations (used for optimistic update cache invalidation)

2. `apps/web/src/routes/project.$id.tsx`
   - Wired up all track mutations with `withOptimisticUpdate`
   - Removed loading states (`isAddingTrack`, `deletingTrackId`) since optimistic updates make actions feel instant
   - Replaced manual error toasts with `showRollbackToast` for consistent error handling

3. `apps/web/src/components/VirtualizedTrackList.tsx`
   - Removed `isAddingTrack` and `deletingTrackId` props
   - Removed `isDeleting` prop from TrackHeader
   - Simplified UI since loading states are no longer needed

### Architecture decisions
- Track mutations now use Convex's native `withOptimisticUpdate` for instant feedback
- The existing `useOptimisticTrackUpdates` hook remains for mute/solo/gain controls since those use a commit-based pattern (local state during interaction, server update on commit)
- Both patterns coexist: Convex optimistic updates for CRUD operations, local React state for continuous interactions

### Notes for next person
- Next priority task: Implement optimistic updates for clip mutations
- The `updateTrack` and `deleteTrack` mutations now accept an optional `projectId` arg - always pass it to enable optimistic updates
- If you need to check if a track is pending (temp ID), use the `isPending()` utility from `@/lib/optimistic`

## 2026-01-29 - Clip Mutations Optimistic Updates

### Completed
Implemented optimistic updates for all clip mutations using Convex's `withOptimisticUpdate` API.

**New file created:** `apps/web/src/lib/clipOptimisticUpdates.ts`
- `createClipOptimisticUpdate` - Instantly adds a new clip with a temp ID to the cache
- `updateClipPositionOptimisticUpdate` - Instantly updates clip's startTime in the cache (for drag operations)
- `deleteClipOptimisticUpdate` - Instantly removes clip from the cache

**Files modified:**
1. `packages/backend/convex/clips.ts`
   - Added optional `projectId` arg to `updateClipPosition` and `deleteClip` mutations (required for optimistic update cache invalidation)

2. `apps/web/src/hooks/useClipDrag.ts`
   - Added `projectId` parameter to the hook
   - Updated mutation call to include `projectId` for optimistic updates
   - Updated error toast to use rollback messaging

3. `apps/web/src/routes/project.$id.tsx`
   - Wired up `updateClipPosition` mutation with `withOptimisticUpdate`
   - Prepared `deleteClip` mutation with optimistic updates (prefixed with `_` since no delete UI exists yet)
   - Passed `projectId` to `useClipDrag` hook

### Architecture decisions
- Clip mutations follow the same pattern as track mutations
- `updateClipPosition` is used for drag-to-move operations - optimistic update provides instant visual feedback when dropping a clip
- `deleteClip` is prepared but not wired to UI yet (no clip delete UI exists)
- `createClip` optimistic update exists but isn't used during upload flow yet - the upload flow currently waits for server confirmation

### Notes for next person
- Next priority tasks: "Implement commit-based updates for continuous interactions" or "Add pending state UI for clips"
- The `updateClipPosition` and `deleteClip` mutations now accept optional `projectId` - always pass it for optimistic updates
- Use `isPending()` from `@/lib/optimistic` to check if a clip has a temp ID (pending confirmation)
- The clip deletion UI needs to be implemented before `deleteClip` can be fully utilized

## 2026-01-29 - Commit-Based Updates for Continuous Interactions

### Completed
Implemented commit-based pattern for gain sliders following FR-6 of the PRD. Gain now updates the audio engine in real-time during slider drag, but only commits to the server on slider release.

**Files modified:**

1. `apps/web/src/components/ui/slider.tsx`
   - Added `onValueCommit` prop that fires on pointer up
   - Tracks current value in a ref to pass to commit callback

2. `apps/web/src/components/VirtualizedTrackList.tsx`
   - Added `onGainCommit` prop to `TrackHeaderProps` and `VirtualizedTrackListProps`
   - `TrackHeader` now uses local `localGain` state for real-time slider feedback
   - `handleGainChange` updates local state + calls `onGainChange` for audio engine
   - `handleGainCommit` commits to server only when value differs from original
   - Added `isDraggingGainRef` to prevent server state from overwriting local state during drag

3. `apps/web/src/hooks/useOptimisticTrackUpdates.ts`
   - Separated gain handlers: `handleUpdateTrackGain` (local only) vs `handleCommitTrackGain` (server)
   - `handleUpdateTrackGain` now only applies local optimistic state (no server call)
   - `handleCommitTrackGain` sends to server and clears optimistic state on completion
   - Mute/solo continue to use immediate update pattern (single click actions)

4. `apps/web/src/routes/project.$id.tsx`
   - Wired up both `onGainChange` and `onGainCommit` to `VirtualizedTrackList`

### Architecture decisions
- Gain slider now follows the commit-based pattern from FR-6
- Track reorder and clip drag were already using commit-based patterns (no changes needed)
- Mute/solo remain immediate (they're discrete toggles, not continuous interactions)
- The Slider component's `onValueCommit` uses `onPointerUp` to detect release

### Notes for next person
- All continuous interactions (gain, track reorder, clip drag) now use commit-based pattern
- Next priority tasks: "Implement upload cancellation" or "Implement optimistic update for project"
- The audio engine receives gain updates in real-time via `onGainChange`, providing instant audio feedback
- Server mutations only fire on commit, reducing unnecessary network requests during slider drag

## 2026-01-29 - Project Optimistic Update

### Completed
Implemented optimistic update for the `updateProject` mutation, enabling instant project name changes.

**New file created:** `apps/web/src/lib/projectOptimisticUpdates.ts`
- `updateProjectOptimisticUpdate` - Instantly applies name change to the `getProject` query cache

**Files modified:**

1. `apps/web/src/routes/project.$id.tsx`
   - Wired up `updateProject` mutation with `withOptimisticUpdate`
   - Removed `isSavingProjectName` loading state since optimistic updates make the action feel instant
   - Replaced `toast.success`/`toast.error` with `showRollbackToast` for consistent error handling
   - Simplified the settings dialog (no loading spinner on save button)
   - Removed unused `toast` import from sonner

### Architecture decisions
- Project mutation follows the same pattern as track/clip mutations
- The dialog now closes immediately on save, with the name change appearing instantly
- On failure, Convex reverts the cache and `showRollbackToast` notifies the user

### Notes for next person
- Remaining tasks: "Implement upload cancellation", "Update audio engine sync", "Add pending state UI for clips"
- The optimistic update pattern is now complete for all main entities: tracks, clips, and project

## 2026-01-29 - Audio Engine Sync Verification

### Completed
Verified that the audio engine correctly reacts to optimistic track gain/mute/solo changes. No code changes were needed - the existing architecture already supports this.

**Verification findings:**

The audio engine sync works correctly through the following flow:
1. `useOptimisticTrackUpdates` hook merges server state with optimistic updates → `tracksWithOptimisticUpdates`
2. `tracksWithOptimisticUpdates` is passed to `useAudioEngine` hook (line 219 in `project.$id.tsx`)
3. `useEffect` in `useAudioEngine.ts` (lines 76-87) syncs tracks to engine when `tracks` prop changes
4. `engine.setTracks()` calls `renderGraph()` which re-renders the DSP graph with new gain/mute/solo values
5. Gain changes use `el.sm()` (smooth) for click-free transitions

**Key architecture points:**
- For gain sliders: local React state provides instant UI feedback, `handleUpdateTrackGain` applies optimistic state that flows to audio engine, server commit happens on slider release
- For mute/solo toggles: immediate optimistic update + server mutation (single action pattern)
- The audio engine receives optimistic state through the merged `tracksWithOptimisticUpdates`, NOT raw Convex query data

### Notes for next person
- Remaining tasks: "Implement upload cancellation", "Add pending state UI for clips"
- Audio engine sync is verified working - optimistic changes to gain/mute/solo immediately affect audio output
- The gain slider uses a commit-based pattern: local state + optimistic update during drag, server mutation on release

## 2026-01-29 - Upload Cancellation

### Completed
Implemented upload cancellation for track deletion following FR-7 of the PRD. When a track is deleted while uploads are in progress, those uploads are now cancelled via AbortController.

**New file created:** `apps/web/src/lib/uploadRegistry.ts`
- `registerUpload(trackId, fileName)` - Registers an upload and returns an AbortController for fetch signal
- `unregisterUpload(trackId, abortController)` - Cleans up after upload completes (success or failure)
- `cancelUploadsForTrack(trackId)` - Aborts all pending uploads for a track (called during deletion)
- `hasPendingUploads(trackId)` - Check if track has pending uploads
- `getPendingUploadCount(trackId)` - Get count of pending uploads for a track

**Files modified:**

1. `apps/web/src/hooks/useTimelineFileDrop.ts`
   - Integrated with upload registry: each upload gets an AbortController registered at start
   - Passes `signal` to fetch call for cancellation support
   - Checks `abortController.signal.aborted` before each async step (decode → upload → validate → create)
   - AbortError is caught and silently ignored (intentional cancellation, no error toast)
   - Always unregisters upload in finally block

2. `apps/web/src/routes/project.$id.tsx`
   - `handleDeleteTrack` now calls `cancelUploadsForTrack(trackId)` before deletion
   - Imported `cancelUploadsForTrack` from uploadRegistry

### Architecture decisions
- Upload registry uses a module-level Map to track pending uploads (simple, no React context needed)
- Each upload is keyed by trackId, allowing multiple concurrent uploads per track
- AbortController signal is passed to fetch for native browser cancellation
- Early exit checks after each async step ensure we don't proceed after cancellation
- No error toast for AbortError since cancellation is intentional user action

### Notes for next person
- Remaining task: "Add pending state UI for clips"
- The upload registry utilities can also be used to show pending upload count in UI if needed
- If implementing upload progress, the AbortController could be extended to track upload percentage
- The pattern can be reused for any other cancellable async operations

## 2026-01-29 - Pending State UI for Clips

### Completed
Implemented visual indicators for clips awaiting server confirmation (optimistic clips with temp IDs).

**Files modified:**

1. `apps/web/src/lib/canvasRenderer.ts`
   - Extended `ClipRenderData` interface with optional `pending` flag
   - Added `createPendingPattern()` function to generate diagonal stripe overlay
   - Modified `drawClips()` to render pending clips with:
     - Lower opacity (0.4 vs 0.7 for confirmed clips)
     - Diagonal stripe pattern overlay
     - Dashed border instead of solid
     - Reduced text opacity

2. `apps/web/src/hooks/useClipDrag.ts`
   - Extended `ClipData` interface with optional `pending` flag
   - Modified `handleMouseDown` to prevent dragging pending clips (they cannot be moved until server confirms)

3. `apps/web/src/routes/project.$id.tsx`
   - Imported `isPending` utility from `@/lib/optimistic`
   - Updated clip mapping to include `pending: isPending(clip)` flag

### Architecture decisions
- Pending clips are identified using the existing `isPending()` utility which checks for `temp_` prefix in IDs
- Visual indicators use canvas rendering: diagonal stripes + dashed border + reduced opacity
- Pending clips are explicitly non-draggable per PRD decisions ("Pending clips are NOT draggable until server confirms")
- No additional React state needed - pending state flows through from Convex optimistic updates

### Visual design for pending clips
- Background: Same track color but with 0.4 opacity (vs 0.7 for confirmed)
- Overlay: Diagonal stripe pattern using semi-transparent white
- Border: Dashed line (4px on, 4px off) at 0.6 opacity
- Text: Reduced to 0.5 opacity
- Interaction: Cannot be dragged (handleMouseDown returns early)

### Notes for next person
- The PRD for optimistic updates is now COMPLETE - all tasks are checked off
- If implementing upload progress percentage, consider adding a progress bar inside the pending clip
- The stripe pattern is created per-render (could be cached for performance if needed)

## 2026-01-29 - Clip Selection State (FR-1 through FR-9)

### Completed
Implemented clip selection for the timeline canvas, enabling multi-clip operations.

**New file:** `apps/web/src/hooks/useClipSelection.ts`
- `selectClip()` - Single click selects one clip (FR-1)
- `toggleClipSelection()` - Shift+click adds/removes from selection (FR-2, FR-3)
- `clearSelection()` - Deselect all clips (FR-5, FR-6)
- `selectAllOnFocusedTrack()` - Cmd+A selects all clips on focused track (FR-4)
- `focusedTrackId` state for Cmd+A behavior and track indicator

**Files modified:**
1. `apps/web/src/lib/canvasRenderer.ts`
   - Added `selected` property to `ClipRenderData`
   - Selected clips render with white border (2px), subtle glow effect

2. `apps/web/src/hooks/useTimelineCanvasEvents.ts`
   - Added `onSelectClip`, `onToggleClipSelection`, `onClearSelection` callbacks
   - Click on clip → select (or shift+click → toggle)
   - Click empty area → clear selection and seek

3. `apps/web/src/components/VirtualizedTrackList.tsx`
   - Added `focusedTrackId` prop and `isFocused` to TrackHeader
   - Focused track shows 2px left border accent (FR-9)

4. `apps/web/src/routes/project.$id.tsx`
   - Wired up `useClipSelection` hook
   - Added Escape key → clear selection (FR-6)
   - Added Cmd+A → select all on focused track (FR-4)
   - Passed selection state to canvas and track list

### Notes for next person
- Next priority: "Implement Delete/Backspace to delete selected clips"
- Pending clips (temp IDs) cannot be selected per FR-8
- Selection is scoped to single track per FR-3 - shift+clicking on different track clears previous selection
- `selectedClipIds` is a Set for O(1) lookup

## 2026-01-29 - Delete Selected Clips (FR-10 through FR-13)

### Completed
Implemented Delete/Backspace keyboard shortcut to delete all selected clips.

**Files modified:**
1. `apps/web/src/routes/project.$id.tsx`
   - Moved `deleteClip` mutation from `TimelineCanvas` to `ProjectEditor` component
   - Added `handleDeleteSelectedClips` callback that deletes all selected clips in parallel
   - Added Delete/Backspace keyboard handler (FR-10)
   - Clears selection before deletion for immediate visual feedback
   - Uses optimistic updates (FR-11) and shows rollback toast on failure (FR-12)

### Notes for next person
- Next priority: "Add trim handles to clip edges" (FR-14 through FR-22)
- The `deleteClip` mutation also deletes the associated audio file from storage (FR-13)
- Deletion happens in parallel for all selected clips for better performance
- Selection is cleared immediately (optimistic behavior) - if deletion fails, clip reappears via Convex rollback

## 2026-01-29 - Trim Handles on Clip Edges (FR-14, FR-15)

### Completed
Implemented visual trim handles on clip edges with cursor feedback.

**Files modified:**
1. `apps/web/src/lib/timelineConstants.ts`
   - Added `TRIM_HANDLE_WIDTH = 8` constant

2. `apps/web/src/hooks/useClipDrag.ts`
   - Added `ClipHoverZone` type ("left" | "right" | "body")
   - Added `ClipAtPosition` interface returning clip + zone
   - `findClipAtPosition` now detects which zone is hovered (FR-14: 8px edge zones)
   - `handleMouseDown` only starts drag on body, not trim handles

3. `apps/web/src/hooks/useTimelineCanvasEvents.ts`
   - Added `hoveredClipId` and `hoveredClipZone` state
   - `handleMouseMove` tracks hovered clip and zone
   - Returns hover state for cursor and rendering

4. `apps/web/src/lib/canvasRenderer.ts`
   - Added `ClipHoverZone` type and `hoverZone` to `ClipRenderData`
   - Draws semi-transparent white overlays on trim handles when hovered
   - Left/right handles highlight on hover, both show faintly when hovering body

5. `apps/web/src/routes/project.$id.tsx`
   - Passes `hoveredClipId`/`hoveredClipZone` to clips for rendering
   - Cursor changes to `ew-resize` when hovering trim handles (FR-15)

### Notes for next person
- Next priority: "Implement trim drag logic constrained to audio boundaries" (FR-16 through FR-22)
- Trim handles only appear on clips wide enough (>= 2x handle width)
- Clicking trim handle zones currently does nothing - trim drag needs implementation
- Selection still works when clicking trim handles

## 2026-01-29 - Trim Drag Logic (FR-16 through FR-22)

### Completed
Implemented full trim drag functionality with audio boundary constraints.

**Schema changes:**
- Added `audioDuration` field to clips table (stores original audio file duration, immutable)

**New backend mutation:**
- `trimClip` in `clips.ts` - updates startTime, audioStartTime, duration with validation for FR-18/FR-19

**Files modified:**
1. `packages/backend/convex/schema.ts` - Added `audioDuration` field
2. `packages/backend/convex/clips.ts` - Added `audioDuration` to createClip, added `trimClip` mutation
3. `apps/web/src/lib/clipOptimisticUpdates.ts` - Added `trimClipOptimisticUpdate`, updated createClip to include audioDuration
4. `apps/web/src/hooks/useClipDrag.ts`:
   - Added `TrimDragState` interface
   - Added `audioStartTime`/`audioDuration` to ClipData
   - handleMouseDown starts trim drag when clicking handles
   - handleMouseMove calculates new trim values with constraints
   - handleMouseUp commits trim via mutation
5. `apps/web/src/lib/canvasRenderer.ts` - Added `TrimDragState`, clips show live trim preview during drag
6. `apps/web/src/routes/project.$id.tsx` - Wired up trimClip mutation, passes trimDragState to renderer

**Trim behavior:**
- Left handle: adjusts startTime and audioStartTime together (FR-16)
- Right handle: adjusts duration only (FR-17)
- Constrained: audioStartTime >= 0 (FR-18), audioStartTime + duration <= audioDuration (FR-19)
- Minimum duration: 1 sample (FR-20)
- Uses optimistic updates (FR-21)
- Visual feedback during drag (FR-22)

### Notes for next person
- Next priorities: copy/paste (Cmd+C/V), cross-track drag, or split (Cmd+E)
- Older clips without audioDuration fall back to audioStartTime + duration
- trimDragState is separate from clipDragState - only one active at a time
